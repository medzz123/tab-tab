name: Infra release

on: 
  workflow_call:
    inputs:
      gcp-project-id:
        required: true
        type: string
      gcp-region:
        required: true
        type: string
      pulumi-stack-name:
        required: true
        type: string
      pulumi-cloud-url:
        required: true
        type: string
      image-tag:
        required: true
        type: string
      frontend-config-file-name:
        required: true
        type: string
      database-proxy:
        required: true
        type: string
        
    secrets:
      pulumi-config-passphrase:
        required: true
      gcp-sa-key:
        required: true
      main-db-url:
        required: true

jobs:
  deploy:
    name: Deploy ðŸš€
    timeout-minutes: 40
    runs-on: blacksmith-2vcpu-ubuntu-2404
    permissions:
      contents: 'read'
      id-token: 'write'
      actions: 'read'
    env:
      DATABASE_URL: ${{ secrets.main-db-url }}
      DATABASE_PROXY: ${{ inputs.database-proxy }}
      FINANCIALS_DATABASE_URL: ${{ secrets.financials-db-url }}
      FINANCIALS_DATABASE_PROXY: ${{ inputs.financials-database-proxy }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.16.0"
          cache: "pnpm"
          cache-dependency-path: "**/pnpm-lock.yaml"
      - run: pnpm install --frozen-lockfile
      - run: pnpm turbo run build --filter=@playter/deployment-v2

      - uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.gcp-sa-key }}
      - uses: google-github-actions/setup-gcloud@v3

      - name: Cache Cloud SQL Proxy
        id: cache-proxy
        uses: actions/cache@v4
        with:
          path: cloud_sql_proxy
          key: cloud-sql-proxy-${{ runner.os }}-v2.12.0

      - name: Download Cloud SQL Proxy
        if: steps.cache-proxy.outputs.cache-hit != 'true'
        run: |
          curl -o cloud_sql_proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.12.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud_sql_proxy

      - run: pnpm turbo db:generate

      - run: |
          echo "DATABASE_URL=${{ env.DATABASE_URL }}" > .env
          echo "FINANCIALS_DATABASE_URL=${{ env.FINANCIALS_DATABASE_URL }}" >> .env

          echo "DATABASE_URL=${{ env.DATABASE_URL }}" > libs/prisma/.env
          echo "FINANCIALS_DATABASE_URL=${{ env.FINANCIALS_DATABASE_URL }}" > libs/financials-prisma/.env

      - name: Migrate database
        env:
          PRISMA_LOG_LEVEL: debug
          DEBUG: "prisma:*"
        run: ./cloud_sql_proxy ${{ env.DATABASE_PROXY }} --port=5432 & sleep 20; pnpm turbo run @playter/prisma#db:deploy

      - name: Migrate database (Financials)
        env:
          PRISMA_LOG_LEVEL: debug
          DEBUG: "prisma:*"
        run: ./cloud_sql_proxy ${{ env.FINANCIALS_DATABASE_PROXY }} --port=5555 & sleep 20; pnpm turbo run @playter/financials-prisma#db:deploy

      - name: Deploy stack
        uses: pulumi/actions@v6
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.dev-pulumi-config-passphrase }}
        with:
          command: up
          stack-name: ${{ inputs.pulumi-stack-name }}
          work-dir: apps/deployment-v2
          refresh: true
          upsert: true
          config-map: |
            imageTag:
              value: ${{ inputs.image-tag }}
          cloud-url: ${{ inputs.pulumi-cloud-url }}
          log-flow: true
          log-verbosity: 3
          debug: false
          suppress-progress: true

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.wif-provider }}
          service_account: ${{ secrets.wif-service-account }}
      - uses: google-github-actions/setup-gcloud@v3
      
      - run: pnpm --workspace-root --filter @playter/scripts run deploy-frontend
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.netlify-auth-token }}
          SITE_ID: ${{ inputs.netlify-site-id }}
          CONFIG_FILE_NAME: ${{ inputs.frontend-config-file-name }}
          BUILD_SOURCE_GS_URL: gs://playter-builds/${{ inputs.image-tag }}/app.zip
          GITHUB_WORKSPACE: ${{ github.workspace }}